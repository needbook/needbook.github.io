"use strict";function authPromise(a){return a.resolve().$promise}function authorPromise(a,b){return b.get({id:a.id}).$promise}function discoverBooksPromise(a){return a.discover().$promise}function bookPromise(a,b){return b.get({id:a.bookID}).$promise}function bookCharactersPromise(a,b){return b.query({bookID:a.bookID}).$promise}function bookCharacterPromise(a,b){return b.get({bookID:a.bookID,charID:a.charID,simple:!1,"with":"traits,links,moves"}).$promise}function characterTraitTypesPromise(a){return a.query().$promise}function characterLinkTypesPromise(a){return a.query().$promise}function libraryPromise(a){return a.query().$promise}function bookPlacePromise(a,b){return b.get({bookID:a.bookID,placeID:a.placeID}).$promise}function bookPlacesPromise(a,b){return b.query({bookID:a.bookID}).$promise}function placeTraitTypesPromise(a){return a.query().$promise}function searchPromise(a,b){return b.query({query:a.query}).$promise}function seriePromise(a,b){return b.get({id:a.id}).$promise}function Author(a){this.EntityType="Author",angular.extend(this,a)}function Book(a){this.EntityType="Book",angular.extend(this,a)}function PlaceTrait(a){this.EntityType="PlaceTrait",angular.extend(this,a)}function PlaceTraitType(a){this.EntityType="PlaceTraitType",angular.extend(this,a)}function Client(a){this.EntityType="Client",angular.extend(this,a)}function Edition(a){this.EntityType="Edition",angular.extend(this,a)}function Library(a){this.EntityType="Library",angular.extend(this,a)}function Search(a){this.EntityType="Search",angular.extend(this,a)}function Serie(a){this.EntityType="Serie",angular.extend(this,a)}function User(a){this.EntityType="User",this.Books=[],this.booksLoaded=!1,angular.extend(this,a),this.Firstname&&this.Lastname?this.Fullname=this.Firstname+" "+this.Lastname:this.Fullname=this.Firstname||this.Lastname,this.loadBooks=function(a,b){var c=this;c.booksLoaded?b():a.ofUser({userID:c.id},function(a){c.Books=a,c.booksLoaded=!0,b()})},this.addBook=function(a){this.Books.push(a)}}angular.module("needbookApp",["ngAnimate","ngAria","ngCookies","ngResource","ngRoute","ngSanitize","ngMaterial","ngMdIcons","ui.router","md.data.table","angular.filter","angular-timeline","jm.i18next","app.ngResource","app.lodash","apiModels","authControllers","authorControllers","bookControllers","serieControllers"]).run(["$rootScope","$state","AUTH_EVENTS","Locales",function(a,b,c){a.$on("$stateChangeError",function(){b.go("home.login")})}]);var needbookApp=angular.module("needbookApp");needbookApp.config(["$httpProvider",function(a){a.interceptors.push(["$injector",function(a){return a.get("AuthInterceptor")}])}]).factory("AuthInterceptor",["$rootScope","$q","AUTH_EVENTS",function(a,b,c){return{responseError:function(d){return a.$broadcast({401:c.notAuthenticated,403:c.notAuthorized,419:c.sessionTimeout,440:c.sessionTimeout}[d.status],d),b.reject(d)}}}]);var needbookApp=angular.module("needbookApp");needbookApp.constant("AUTH_EVENTS",{clientAuthSuccess:"auth:client-success",clientAuthFailed:"auth:client-failed",registrationSuccess:"auth:registration-success",registrationFailed:"auth:registration-failed",deletionSuccess:"auth:deletion-success",deletionFailed:"auth:deletion-failed",loginSuccess:"auth:login-success",loginFailed:"auth:login-failed",logoutSuccess:"auth:logout-success",sessionCreated:"auth:session-created",sessionDeleted:"auth:session-deleted",sessionTimeout:"auth:session-timeout",notAuthenticated:"auth:not-authenticated",notAuthorized:"auth:not-authorized"}).constant("USER_ROLES",{all:"*",admin:"admin",editor:"editor",guest:"guest"}).constant("CHARACTER_EVENTS",{createSuccess:"character.create-success",createFailed:"character.create-failed",createTraitSuccess:"character:create-trait-success",createTraitFailed:"character:create-trait-failed",createLinkSuccess:"character:create-link-success",createLinkFailed:"character:create-link-failed",createLinkTraitSuccess:"character:create-link-trait-success",createLinkTraitFailed:"character:create-link-trait-failed",createMoveSuccess:"character:create-move-success",createMoveFailed:"character:create-move-failed",createActionSuccess:"character:create-action-success",createActionFailed:"character:create-action-failed",updateSuccess:"character.update-success",updateFailed:"character.update-failed",deleteSuccess:"character.delete-success",deleteFailed:"character.delete-failed",deleteTraitSuccess:"character:delete-trait-success",deleteTraitFailed:"character:delete-trait-failed",deleteLinkSuccess:"character:delete-link-success",deleteLinkFailed:"character:delete-link-failed",deleteMoveSuccess:"character:delete-move-success",deleteMoveFailed:"character:delete-move-failed",deleteActionSuccess:"character:delete-action-success",deleteActionFailed:"character:delete-action-failed"});var needbookApp=angular.module("needbookApp");needbookApp.controller("AppCtrl",["$timeout","$log","$rootScope","$scope","$state","$mdSidenav","$mdToast","$mdUtil","$i18next","USER_ROLES","AUTH_EVENTS","AuthService","Locales","Session",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){function o(a){var c=h.debounce(function(){f(a).toggle().then(function(){b.debug("toggle "+a+" is done")})},200);return c}c.pageTitle="Page Title",d.currentUser=null,d.userRoles=j,d.isAuthorized=l.isAuthorized,d.i18nextReady=!1,d.lng=m.getLng(),d.changeLng=function(a){m.setLng(a),console.log(i.debugMsg[i.debugMsg.length-1])},d.toggleLeft=o("left"),l.clientConnection(),d.logout=l.logout,d.$on(k.loginSuccess,function(){g.show(g.simple().position("bottom right").content("Login Success")),e.go("app.library.books")}),d.$on(k.loginFailed,function(){g.show(g.simple().position("bottom right").content("Login Failure"))}),d.$on(k.deletionSuccess,function(){g.show(g.simple().position("bottom right").content("Account Deleted"))}),d.$on(k.deletionFailure,function(){}),d.$on(k.sessionCreated,function(){d.currentUser||(d.currentUser=n.loadState())}),d.$on(k.sessionDeleted,function(){d.currentUser=null,e.go("home")}),d.$on("i18nextLanguageChange",function(){console.log("Language has changed!"),d.i18nextReady||a(function(){d.i18nextReady=!0},500)})}]);var needbookApp=angular.module("needbookApp");authPromise.$inject=["AuthResolver"],authorPromise.$inject=["$stateParams","AuthorModel"],discoverBooksPromise.$inject=["BookModel"],bookPromise.$inject=["$stateParams","BookModel"],bookCharactersPromise.$inject=["$stateParams","BookCharacterModel"],bookCharacterPromise.$inject=["$stateParams","BookCharacterModel"],characterTraitTypesPromise.$inject=["CharacterTraitTypeModel"],characterLinkTypesPromise.$inject=["CharacterLinkTypeModel"],libraryPromise.$inject=["LibraryModel"],bookPlacePromise.$inject=["$stateParams","BookPlaceModel"],bookPlacesPromise.$inject=["$stateParams","BookPlaceModel"],placeTraitTypesPromise.$inject=["PlaceTraitTypeModel"],searchPromise.$inject=["$stateParams","SearchModel"],seriePromise.$inject=["$stateParams","SerieModel"],needbookApp.config(["$stateProvider","$urlRouterProvider","$httpProvider",function(a,b,c){c.defaults.withCredentials=!0,b.otherwise("/home"),a.state("home",{url:"/home",data:{requireLogin:!1},views:{content:{templateUrl:"components/home/homeView.html"}}}).state("home.login",{url:"/login",views:{"content@":{templateUrl:"components/auth/loginView.html",controller:"LoginCtrl"}}}).state("home.sign_up",{url:"/sign_up",views:{"content@":{templateUrl:"components/auth/signUpView.html",controller:"SignUpCtrl"}}}).state("app",{"abstract":!0,data:{requireLogin:!0},views:{header:{templateUrl:"shared/core/toolbar/simpleToolbarView.html",controller:"SimpleToolbarCtrl"},sidenav:{templateUrl:"shared/core/sidenav/sidenavView.html",controller:"SidenavCtrl"}},resolve:{auth:authPromise}}).state("app.search",{url:"/search/:query",views:{"content@":{templateUrl:"components/search/searchResultView.html",controller:"SearchCtrl"}},resolve:{SearchData:searchPromise}}).state("app.book",{url:"/book/:bookID","abstract":!0}).state("app.book.details",{url:"",views:{"content@":{templateUrl:"components/book/bookDetailView.html",controller:"BookDetailCtrl"}},resolve:{LibraryData:libraryPromise,BookData:bookPromise,BookCharactersData:bookCharactersPromise,BookPlacesData:bookPlacesPromise}}).state("app.book.characters",{url:"/chars","abstract":!0}).state("app.book.character",{url:"/char/:charID",views:{"content@":{templateUrl:"components/book/character/bookCharacterListView.html",controller:"BookCharacterListCtrl"}},resolve:{BookCharactersData:bookCharactersPromise,BookCharacterData:bookCharacterPromise}}).state("app.book.character.edit",{url:"/edit",views:{"content@":{templateUrl:"components/book/character/bookCharacterEditView.html",controller:"BookCharacterEditCtrl"}},resolve:{BookData:bookPromise,BookCharactersData:bookCharactersPromise,BookCharacterData:bookCharacterPromise,CharacterTraitTypesData:characterTraitTypesPromise,CharacterLinkTypesData:characterLinkTypesPromise}}).state("app.book.characters.new",{url:"/new",views:{"content@":{templateUrl:"components/book/character/bookCharacterEditView.html",controller:"BookCharacterEditCtrl"}},resolve:{BookData:bookPromise,BookCharactersData:bookCharactersPromise,BookCharacterData:bookCharacterPromise,CharacterTraitTypesData:characterTraitTypesPromise,CharacterLinkTypesData:characterLinkTypesPromise}}).state("app.book.places",{url:"/places",views:{"content@":{templateUrl:"components/book/place/bookPlaceListView.html",controller:"BookPlaceListCtrl"}}}).state("app.book.place",{url:"/place/:placeID",views:{"content@":{templateUrl:"components/book/place/bookPlaceDetailView.html",controller:"BookPlaceDetailCtrl"}},resolve:{BookData:bookPromise,BookPlaceData:bookPlacePromise,BookPlacesData:bookPlacesPromise}}).state("app.book.place.edit",{url:"/edit",views:{"content@":{templateUrl:"components/book/place/bookPlaceEditView.html",controller:"BookPlaceEditCtrl"}},resolve:{BookData:bookPromise,BookPlaceData:bookPlacePromise,BookPlacesData:bookPlacesPromise,PlaceTraitTypesData:placeTraitTypesPromise}}).state("app.book.places.new",{url:"/new",views:{"content@":{templateUrl:"components/book/place/bookPlaceEditView.html",controller:"BookPlaceEditCtrl"}},resolve:{BookData:bookPromise,BookPlaceData:bookPlacePromise,BookPlacesData:bookPlacesPromise,PlaceTraitTypesData:placeTraitTypesPromise}}).state("app.serie",{url:"/serie/:id",views:{"content@":{templateUrl:"components/serie/serieDetailView.html",controller:"SerieDetailCtrl"}},resolve:{SerieData:seriePromise}}).state("app.author",{url:"/author/:id",views:{"content@":{templateUrl:"components/author/authorDetailView.html",controller:"AuthorDetailCtrl"}},resolve:{AuthorData:authorPromise}}).state("app.library",{url:"/library","abstract":!0,views:{"header@":{templateUrl:"shared/core/toolbar/simpleToolbarView.html",controller:"SimpleToolbarCtrl"}},resolve:{LibraryData:libraryPromise}}).state("app.library.books",{url:"/books",views:{"content@":{templateUrl:"components/book/bookListView.html",controller:"LibraryBookListCtrl"}}}).state("app.library.series",{url:"/series",views:{"content@":{templateUrl:"components/serie/serieListView.html",controller:"SerieListCtrl"}}}).state("app.library.authors",{url:"/authors",views:{"content@":{templateUrl:"components/author/authorListView.html",controller:"LibraryAuthorListCtrl"}}}).state("app.discover",{url:"/discover",views:{"content@":{templateUrl:"components/book/bookListView.html",controller:"DiscoverCtrl"}},resolve:{DiscoverBooksData:discoverBooksPromise}}).state("app.settings",{url:"/settings",views:{"content@":{templateUrl:"components/settings/settingsView.html",controller:"SettingsCtrl"}}})}]),angular.module("app.ngResource",["ngResource","ngCookies"]).factory("Resource",["$resource","$cookies",function(a,b){return function(b,c,d){var e=function(a){return angular.forEach(arguments,function(b){b!==a&&angular.forEach(b,function(b,c){a[c]&&a[c].constructor&&a[c].constructor===Object?e(a[c],b):a[c]=b})}),a};delete c.model;var f={post:{method:"POST"},patch:{method:"PATCH"},create:{method:"POST"},update:{method:"PUT",isArray:!1},query:{isArray:!0}};d=e({},f,d),c=angular.extend({id:"@id"},c);var g=a(b,c,d);return g.prototype.$save=function(){return this.id?this.$update():this.$create()},g}}]);var needbookApp=angular.module("needbookApp");needbookApp.factory("config",[function(){var a="production",b={production:{apiUrl:"http://api.needbook.io:1337",clientName:"Admin",clientKey:"Ls5Peq5sfZcJHhkv54dfsdLg35HVfdff977fHF2S4354ZhkgyklMd5",log:!0},development:{apiUrl:"http://localhost:1337",clientName:"Admin",clientKey:"Ls5Peq5sfZcJHhkv54dfsdLg35HVfdff977fHF2S4354ZhkgyklMd5",log:!0}};return b[a]}]);var needbookApp=angular.module("needbookApp");needbookApp.config(["$mdThemingProvider",function(a){a.theme("needbook").primaryPalette("brown").accentPalette("amber").warnPalette("red").backgroundPalette("grey"),a.setDefaultTheme("needbook")}]);var translations=angular.module("jm.i18next");translations.config(["$i18nextProvider",function(a){a.options={cookieName:"lng",useLocalStorage:!1,fallbackLng:"en",resGetPath:"locales/__lng__/translation.json",defaultLoadingValue:""}}]);var underscore=angular.module("app.lodash",[]);underscore.factory("_",["$window",function(a){return a._}]),angular.module("apiModels",[]);var apiModels=angular.module("apiModels");apiModels.factory("AuthorModel",["_","Resource","config",function(a,b,c){function d(a){return new Author(angular.fromJson(a))}function e(b){return a.map(angular.fromJson(b),function(a){return new Author(a)})}return b(c.apiUrl+"/authors/:id",{id:"@id"},{query:{transformResponse:e},get:{transformResponse:d}})}]);var apiModels=angular.module("apiModels");apiModels.factory("BookModel",["_","Resource","config",function(a,b,c){function d(a){return new Book(angular.fromJson(a))}function e(b){return a.map(angular.fromJson(b),function(a){return new Book(a)})}return b(c.apiUrl+"/books/:id",{id:"@id"},{query:{transformResponse:e},get:{transformResponse:d},discover:{url:c.apiUrl+"/discover",transformResponse:e,isArray:!0}})}]);var apiModels=angular.module("apiModels");apiModels.factory("MapModel",["_","Resource","config",function(a,b,c){return b(c.apiUrl+"/maps/:id",{id:"@id"},{})}]),apiModels.factory("BookMapModel",["_","Resource","config",function(a,b,c){return b(c.apiUrl+"/books/:bookID/map/:mapID",{bookID:"@bookID",mapID:"@mapID"},{add:{method:"POST"},get:{url:"/books/:bookID/map"}})}]);var apiModels=angular.module("apiModels");apiModels.factory("Place",[function(){function a(a){this.EntityType="Place",angular.extend(this,a),this.name=function(){return this.indexedTraits().names[0].values.en_US[0]},this.indexedTraits=function(){return this._indexedTraits?this._indexedTraits:(this._indexedTraits=_.groupBy(this.traits,function(a){return angular.lowercase(a.trait.names.en_US)}),this._indexedTraits)}}return a}]),apiModels.factory("PlaceModel",["_","Resource","config","Place",function(a,b,c,d){function e(a){return new d(angular.fromJson(a))}function f(b){return a.map(angular.fromJson(b),function(a){return new d(a)})}return b(c.apiUrl+"/places/:id",{id:"@id"},{query:{transformResponse:f},get:{transformResponse:e},save:{method:"POST",transformResponse:e}})}]),apiModels.factory("BookPlaceModel",["_","Resource","config","Place",function(a,b,c,d){function e(a){return new d(angular.fromJson(a))}function f(b){return a.map(angular.fromJson(b),function(a){return new d(a)})}return b(c.apiUrl+"/books/:bookID/places/:placeID",{bookID:"@bookID",charID:"@placeID"},{query:{transformResponse:f},get:{transformResponse:e},save:{method:"POST"}})}]);var apiModels=angular.module("apiModels");apiModels.factory("PlaceTraitModel",["_","Resource","config",function(a,b,c){function d(a){return new PlaceTrait(angular.fromJson(a))}return b(c.apiUrl+"/places/:place/traits/:id",{place:"@place",id:"@id"},{get:{method:"GET",transformResponse:d,isArray:!1},post:{method:"POST",transformResponse:d,isArray:!1}})}]),apiModels.factory("PlaceTraitTypeModel",["_","Resource","config",function(a,b,c){function d(a){return new PlaceTraitType(angular.fromJson(a))}function e(b){return a.map(b,function(a){return new PlaceTraitType(a)})}function f(a){return e(angular.fromJson(a))}function g(a){return a=angular.fromJson(a),e(a.place_trait_type)}return b(c.apiUrl+"/places/traits/_types/:id",{id:"@id"},{get:{method:"GET",transformResponse:d,isArray:!1},query:{method:"GET",transformResponse:f,isArray:!0},post:{method:"POST",transformResponse:d,isArray:!1},search:{method:"GET",transformResponse:g,isArray:!0,url:c.apiUrl+"/search",params:{types:"place_trait_type"}}})}]);var apiModels=angular.module("apiModels");apiModels.factory("CharacterTrait",["CharacterEvent",function(a){function b(b,c){this.values={en_US:[]},this.begin_locations=[],this.end_locations=[],this.calculated_begin_location=null,angular.extend(this,a(b,"trait",c)),angular.extend(this,c)}return b.prototype.name=function(a){return this.trait.names[a]||this.trait.names.en_US},b}]),apiModels.factory("CharacterTraitModel",["_","Resource","config","CharacterTrait",function(a,b,c,d){function e(a){return new d(null,angular.fromJson(a))}return b(c.apiUrl+"/characters/:character/traits/:id",{character:"@character",id:"@id"},{get:{method:"GET",transformResponse:e,isArray:!1},post:{method:"POST",transformResponse:e,isArray:!1},"delete":{method:"DELETE"}})}]),apiModels.factory("CharacterTraitType",[function(){function a(a){this.EntityType="CharacterTraitType",angular.extend(this,a)}return a}]),apiModels.factory("CharacterTraitTypeModel",["_","Resource","config","CharacterTraitType",function(a,b,c,d){function e(a){return new d(angular.fromJson(a))}function f(b){return a.map(b,function(a){return new d(a)})}function g(a){return f(angular.fromJson(a))}function h(a){return a=angular.fromJson(a),f(a.character_trait_type)}return b(c.apiUrl+"/characters/traits/_types/:id",{id:"@id"},{get:{method:"GET",transformResponse:e,isArray:!1},query:{method:"GET",transformResponse:g,isArray:!0},post:{method:"POST",transformResponse:e,isArray:!1},search:{method:"GET",transformResponse:h,isArray:!0,url:c.apiUrl+"/search",params:{types:"character_trait_type"}}})}]);var apiModels=angular.module("apiModels");apiModels.factory("CharacterLink",["CharacterEvent",function(a){function b(b,c){angular.extend(this,a(b,"link",c)),this.begin_locations=[],this.end_locations=[],angular.extend(this,c),this.from=b,b&&this.to&&(this.to=b.$new(this.to))}return b.prototype.name=function(a){return this.link.names[a]||this.link.names.en_US},b.prototype.toJson=function(){var a=_.clone(this);return a.from&&(a.from=a.from.id),a.to&&(a.to=a.to.id),a},b}]),apiModels.factory("CharacterLinkModel",["_","Resource","config","CharacterLink",function(a,b,c,d){function e(a){return new d(null,angular.fromJson(a))}return b(c.apiUrl+"/characters/:character/links/:id",{character:"@character",id:"@id"},{get:{method:"GET",transformResponse:e,isArray:!1},post:{method:"POST",transformResponse:e,isArray:!1},"delete":{method:"DELETE"}})}]),apiModels.factory("CharacterLinkType",[function(){function a(a){this.EntityType="CharacterLinkType",angular.extend(this,a),this.name=function(){return this.names.en_US}}return a}]),apiModels.factory("CharacterLinkTypeModel",["_","Resource","config","CharacterLinkType",function(a,b,c,d){function e(a){return new d(angular.fromJson(a))}function f(b){return a.map(b,function(a){return new d(a)})}function g(a){return f(angular.fromJson(a))}function h(a){return a=angular.fromJson(a),f(a.character_link_type)}return b(c.apiUrl+"/characters/links/_types/:id",{id:"@id"},{get:{method:"GET",transformResponse:e,isArray:!1},query:{method:"GET",transformResponse:g,isArray:!0},post:{method:"POST",transformResponse:e,isArray:!1},search:{method:"GET",transformResponse:h,isArray:!0,url:c.apiUrl+"/search",params:{types:"character_link_type"}}})}]);var apiModels=angular.module("apiModels");apiModels.factory("CharacterAction",["CharacterEvent",function(a){function b(b,c){angular.extend(this,a(b,"action",c)),this.begin_locations=[],angular.extend(this,c),this.from=b,this.to=_.map(this.to,function(a){return b.$new(a)})}return b.prototype.name=function(a){return this.action.names[a]||this.action.names.en_US},b.prototype.toJson=function(){var a=_.clone(this);return a.from&&(a.from=a.from.id),a.to&&(a.to=a.to.id),a},b}]),apiModels.factory("CharacterActionModel",["_","Resource","config","CharacterAction",function(a,b,c,d){function e(a){return new d(null,angular.fromJson(a))}return b(c.apiUrl+"/characters/:character/actions/:id",{character:"@character",id:"@id"},{get:{method:"GET",transformResponse:e,isArray:!1},post:{method:"POST",transformResponse:e,isArray:!1}})}]),apiModels.factory("CharacterActionType",[function(){function a(a){this.EntityType="CharacterActionType",this.sentences={en_US:""},this.causes=[],this.tags=[],this.names={en_US:""},angular.extend(this,a)}return a}]),apiModels.factory("CharacterActionTypeModel",["_","Resource","config","CharacterActionType","CharacterLinkType","CharacterTraitType",function(a,b,c,d,e,f){function g(a){return console.log("hello"),new d(angular.fromJson(a))}function h(b){return a.map(b,function(a){return new d(a)})}function i(a){return h(angular.fromJson(a))}function j(a){return a=angular.fromJson(a),h(a.character_trait_type)}function k(b){b=angular.fromJson(b);var c=[];return c=a(c).concat(a.map(b.character_trait_type,function(a){return new f(a)})),c=c.concat(a.map(b.character_link_type,function(a){return new e(a)})),c.value()}return b(c.apiUrl+"/characters/actions/_types/:id",{id:"@id"},{get:{method:"GET",transformResponse:g,isArray:!1},query:{method:"GET",transformResponse:i,isArray:!0},post:{method:"POST",transformResponse:g,isArray:!1},search:{method:"GET",transformResponse:j,isArray:!0,url:c.apiUrl+"/search",params:{types:"character_action_type"}},searchCause:{method:"GET",transformResponse:k,isArray:!0,url:c.apiUrl+"/search",params:{types:"character_link_type,character_trait_type"}}})}]);var apiModels=angular.module("apiModels");apiModels.factory("CharacterMove",["CharacterEvent","Place",function(a,b){function c(c,d){angular.extend(this,a("move",d)),angular.extend(this,d),this.from instanceof Object&&(this.from=new b(this.from)),this.to instanceof Object&&(this.to=new b(this.to))}return c.prototype.name=function(a){return this.trait.names[a]||this.trait.names.en_US},c}]),apiModels.factory("CharacterMoveModel",["_","Resource","config","CharacterMove",function(a,b,c,d){function e(a){return new d(null,angular.fromJson(a))}return b(c.apiUrl+"/characters/:character/moves/:id",{character:"@character",id:"@id"},{get:{method:"GET",transformResponse:e,isArray:!1},post:{method:"POST",transformResponse:e,isArray:!1}})}]);var apiModels=angular.module("apiModels");apiModels.factory("CharacterEvent",["_",function(a){function b(b,c){return{calculated_begin_location:null,type:c,_genId:Math.floor(1e8*Math.random()),toSentence:function(b){if(!this[this.type]||!this[this.type].sentences)return"";var c=this[this.type].sentences[b];if(a.isObject(c)&&(c=this.active?c.active:c.passive),c=c.replace("{from}",this.from.name()),console.log("TO SENTENCE"),console.log(this.to),a.isArray(this.to)){var d=a.map(this.to,function(a){return a.name()});c=c.replace("{to}",d.join(", "))}else c=c.replace("{to}",this.to.name());return c}}}return b}]),apiModels.factory("Character",["CharacterTrait","CharacterLink","CharacterMove","CharacterAction",function(a,b,c,d){function e(a){return this.EntityType="Character",this.traits=[],this.links=[],this.moves=[],this.actions=[],this.locations=[{location:""}],this.$new=function(a){return new e(a)},this.mergeEvents=function(){var a=this.traits.concat(this.links,this.moves,this.actions);return _.sortBy(a,function(a){return a.calculated_begin_location?a.calculated_begin_location:null}),a},this.indexedTraits=function(){return this._indexedTraits&&this.id&&!this._editionMode?this._indexedTraits:(this._indexedTraits=_.groupBy(this.traits,function(a){return a.trait?angular.lowercase(a.trait.names.en_US):void 0}),this._indexedTraits)},this.indexedLinks=function(){return this._indexedLinks&&this.id&&!this._editionMode?this._indexedLinks:(this._indexedLinks=_.groupBy(this.links,function(a){return a.link.names?angular.lowercase(a.link.names.en_US):void 0}),this._indexedLinks)},this.indexedActions=function(){return this._indexedActions&&this.id&&!this._editionMode?this._indexedActions:(this._indexedActions=_.groupBy(this.actions,function(a){return angular.lowercase(a.action.names.en_US)}),this._indexedActions)},this.resetIndexing=function(){this._indexedTraits=null,this._indexedLinks=null,this._indexedActions=null},this.addEvent=function(a,b,c){var d={trait:"traits",link:"links",move:"moves",action:"actions"};void 0!==a.from&&(a.from=this),void 0!==a.character&&(a.character=this),_.each(["begin_locations","end_locations","locations"],function(d){_.each(a[d],function(a){a.book?a.edition||a.book!==b.id||(a.edition=c.id):(a.book=b.id,a.edition=c.id)})}),this[d[a.type]].push(a)},this.deleteEvent=function(a){var b={trait:"traits",link:"links",move:"moves",action:"actions"};this[b[a.type]]=_.remove(this[b[a.type]],function(b){return b.id===a.id?!0:!1})},this.name=function(){return this.indexedTraits().names&&0!==this.indexedTraits().names.length?this.indexedTraits().names[0].values.en_US.join(", "):""},this.gender=function(){return this.indexedTraits().gender?this.indexedTraits().gender[this.indexedTraits().gender.length-1].values.en_US.join(", "):""},this.picture=function(){return this.indexedTraits().picture?this.indexedTraits().picture[this.indexedTraits().picture.length-1].values.en_US[0]:""},this.toJson=function(){var a=_.clone(this);return _.each(["traits","links","moves","actions"],function(b){a[b]=_.map(a[b],function(a){return a.toJson?a.toJson():a})}),a},_.isString(a)?void(this.id=a):(angular.extend(this,a),void _.each(["traits","links","moves","actions"],function(a){var b=[];_.isObject(this[a])&&(this[a]=_.values(this[a])),_.each(this[a],function(c){return _.isArray(c)?_.each(c,function(c){b.push(new f[a](this,c))}.bind(this)):void b.push(new f[a](this,c))}.bind(this)),this[a]=_.clone(b)}.bind(this)))}var f={traits:a,links:b,moves:c,actions:d};return e}]),apiModels.factory("CharacterModel",["_","Resource","config","Character",function(a,b,c,d){function e(a){return new d(angular.fromJson(a))}function f(b){return a.map(angular.fromJson(b),function(a){return new d(a)})}function g(b){return a.forEach(b.links,function(a,b){console.log(a),angular.isObject(a.from)&&(a.from=a.from.id),angular.isObject(a.to)&&(a.to=a.to.id),angular.isObject(a.link)&&(a.link=a.link.id)}),angular.toJson(b)}var h=b(c.apiUrl+"/characters/:id",{id:"@id"},{query:{transformResponse:f},get:{transformResponse:e},save:{method:"POST",transformRequest:g,transformResponse:e}});return h["new"]=function(){return new d},h}]),apiModels.factory("BookCharacterModel",["_","Resource","config","Character",function(a,b,c,d){function e(a){return new d(angular.fromJson(a))}function f(b){return a.map(angular.fromJson(b),function(a){return new d(a)})}var g=b(c.apiUrl+"/books/:bookID/characters/:charID",{bookID:"@bookID",charID:"@charID"},{query:{transformResponse:f,cache:!0},get:{transformResponse:e},save:{method:"POST"}});return g["new"]=function(){return new d},g}]);var apiModels=angular.module("apiModels");apiModels.factory("ClientModel",["_","Resource","config",function(a,b,c){function d(a){return new Client(angular.fromJson(a))}return b(c.apiUrl+"/auth/:client_id",{client_id:"@client_id"},{connect:{method:"GET",url:c.apiUrl+"/auth/"+c.clientName+"/"+c.clientKey},disconnect:{url:c.apiUrl+"/auth/stop"},create:{transformResponse:d}})}]);var apiModels=angular.module("apiModels");apiModels.factory("EditionModel",["_","Resource","config",function(a,b,c){function d(a){return new Edition(angular.fromJson(a))}function e(b){return a.map(angular.fromJson(b),function(a){return new Edition(a)})}return b(c.apiUrl+"/editions/:id",{id:"@id"},{query:{transformResponse:e},get:{transformResponse:d}})}]);var apiModels=angular.module("apiModels");apiModels.factory("LibraryModel",["_","Resource","config",function(a,b,c){function d(a){return new Library(angular.fromJson(a))}return b(c.apiUrl+"/library/:id",{id:"@id"},{query:{transformResponse:d,isArray:!1},addBook:{url:c.apiUrl+"/library",method:"POST"},removeBook:{url:c.apiUrl+"/library/:id",method:"DELETE"}})}]);var apiModels=angular.module("apiModels");apiModels.factory("SearchModel",["_","Resource","config",function(a,b,c){function d(a){return new Search(angular.fromJson(a))}return b(c.apiUrl+"/search?q=:query",{query:"@query"},{query:{transformResponse:d,isArray:!1}})}]);var apiModels=angular.module("apiModels");apiModels.factory("SerieModel",["_","Resource","config",function(a,b,c){function d(a){return new Serie(angular.fromJson(a))}function e(b){return a.map(angular.fromJson(b),function(a){return new Serie(a)})}return b(c.apiUrl+"/series/:id",{id:"@id"},{query:{transformResponse:e},get:{transformResponse:d}})}]);var apiModels=angular.module("apiModels");apiModels.factory("UserModel",["_","Resource","config",function(a,b,c){function d(a){return new User(angular.fromJson(a))}return b(c.apiUrl+"/users/:id",{id:"@id"},{create:{method:"POST",transformResponse:d},login:{url:c.apiUrl+"/users/login"},logout:{url:c.apiUrl+"/users/logout"},validateEmail:{url:c.apiUrl+"/user/validate/:login/:key",method:"POST"}})}]);var needbookApp=angular.module("needbookApp");needbookApp.factory("AuthService",["_","$log","AUTH_EVENTS","BroadcastService","ClientModel","UserModel","Session",function(a,b,c,d,e,f,g){var h={};return h.clientConnection=function(){e.connect(function(a){d.sendSuccess(c.clientAuthSuccess,a)},function(a){d.sendFailure(c.clientAuthSuccess,a)})},h.currentUser=function(a,b){f.get({id:g.uid},function(b){a(b)},b)},h.login=function(a){f.login(a,function(a){g.saveState(a.user),g.create(a.user.id),d.sendSuccess(c.loginSuccess,a.user)},function(a){d.sendFailure(c.loginFailed,a)})},h.logout=function(){g.destroy()},h.register=function(b){f.create(b,function(e){d.sendSuccess(c.registrationSuccess,e),h.login(a.pick(b,"login","password"))},function(a){d.sendFailure(c.registrationFailed,a)})},h.deleteUser=function(a){f["delete"]({id:a},function(a){d.sendSuccess(c.deletionSuccess,a),h.logout()},function(a){d.sendFailure(c.deletionFailed,a)})},h.isAuthenticated=function(){return b.info("authService.isAuthenticated",!!g.userId),!!g.userId},h.isAuthorized=function(a){return angular.isArray(a)||(a=[a]),b.info("authService.isAuthorized",h.isAuthenticated()&&-1!==a.indexOf(g.userRole)),h.isAuthenticated()&&-1!==a.indexOf(g.userRole)},h}]),needbookApp.factory("AuthResolver",["$cookies","$q","Session",function(a,b,c){return{resolve:function(){var d=b.defer(),e=a.get("uid");return e?(c.create(e),d.resolve()):d.reject("Not logged in"),d.promise}}}]);var needbookApp=angular.module("needbookApp");needbookApp.factory("BroadcastService",["$log","$rootScope","config",function(a,b,c){var d={};return d.send=function(a,c){b.$broadcast(a,c)},d.sendSuccess=function(b,e){c.log&&a.info(b,e),d.send(b,e)},d.sendFailure=function(b,e){c.log&&a.warn(b,e),d.send(b,e)},d}]);var needbookApp=angular.module("needbookApp");needbookApp.service("Locales",["_","$log","$cookies","$i18next",function(a,b,c,d){this.setLng=function(a){c.put("lng",a),d.options.lng=a},this.getLng=function(){var a=c.get("lng");return a},this.loadLng=function(){var b=c.get("lng");a.isBlank(b)||"en"!==b&&"fr"!==b?this.setLng("en"):this.setLng(b)},this.resetLng=function(){c.remove("lng")}}]),needbookApp.factory("LocalesResolver",["$cookies","$q","Locales",function(a,b,c){return{resolve:function(){var c=b.defer(),d=a.get("lng");return d&&(Locales.setLng(d),c.resolve()),c.promise}}}]);var needbookApp=angular.module("needbookApp");needbookApp.service("Session",["$log","$cookies","BroadcastService","AUTH_EVENTS","USER_ROLES",function(a,b,c,d,e){this.loadState=function(){var b=localStorage.getItem("user");return a.debug("Session.loadState",null!==localStorage.getItem("user")?angular.fromJson(b):null),null!==localStorage.getItem("user")?angular.fromJson(b):null;
},this.saveState=function(b){localStorage.setItem("user",angular.toJson(b)),a.debug("Session.saveState",angular.toJson(b))},this.deleteState=function(){localStorage.removeItem("user")},this.create=function(a,f){this.uid=a,this.userRole=f||e.admin,b.put("uid",a),c.sendSuccess(d.sessionCreated,a)},this.destroy=function(){this.uid=null,this.userRole=null,this.deleteState(),b.remove("uid"),c.sendSuccess(d.sessionDeleted)}}]);var needbookApp=angular.module("needbookApp");needbookApp.service("ToolbarService",["$log","$rootScope",function(a,b){this.setPageTitle=function(a){b.pageTitle=a}}]);var needbookApp=angular.module("needbookApp");needbookApp.controller("AuthorCardCtrl",["$scope",function(a){a.ctrlName="AuthorCardCtrl"}]),needbookApp.directive("authorCard",function(){return{restrict:"E",scope:{author:"="},templateUrl:"shared/author/authorCard.tmpl.html",controller:"AuthorCardCtrl"}});var needbookApp=angular.module("needbookApp");needbookApp.controller("BookCardCtrl",["$scope","BookModel",function(a,b){a.ctrlName="BookCardCtrl",a.bookId&&(a.book=b.get({id:a.bookId}))}]),needbookApp.directive("bookCard",function(){return{restrict:"A",scope:{book:"=",bookId:"@"},templateUrl:"shared/book/bookCard.tmpl.html",controller:"BookCardCtrl"}});var needbookApp=angular.module("needbookApp");needbookApp.controller("CharacterTreeCtrl",["$scope",function(a){a.ctrlName="CharacterTreeCtrl",a.fakeLink={},a.$watch("character",function(b){b&&(a.fakeLink={id:b.id,to:b})}),a.filterOrder=function(b,c){var d=_.filter(b,function(a){return a.link.tree_order===c?!0:void 0});return"indifferent"===c&&d.splice(_.floor(d.length/2),0,a.fakeLink),d}}]),needbookApp.directive("characterTree",function(){return{restrict:"E",scope:{character:"="},templateUrl:"shared/character/characterTree.tmpl.html",controller:"CharacterTreeCtrl"}});var needbookApp=angular.module("needbookApp");needbookApp.controller("characterListCardCtrl",["$scope","$state","BookCharacterModel",function(a,b,c){a.ctrlName="characterListCard",a.emptyMsg="characters.not-found",a.isLoading=!0,a.isEmpty=!0,a.bookId&&(a.characters=c.query({bookID:a.bookId},function(b){a.isEmpty=_.isEmpty(b),a.isLoading=!1})),a.goToCharacter=function(c){b.go("app.book.character",{bookID:a.bookId,charID:c})}}]),needbookApp.directive("characterListCard",function(){return{restrict:"E",scope:{bookId:"="},templateUrl:"shared/character/characterList.tmpl.html",controller:"characterListCardCtrl"}});var needbookApp=angular.module("needbookApp");needbookApp.controller("CharacterLinksCardCtrl",["_","$scope","$state","$stateParams","CharacterLinkModel","CharacterLinkTypeModel","BookCharacterModel",function(a,b,c,d,e,f,g){function h(){b.indexedLinks={},f.query(function(a){a.forEach(function(a){b.indexedLinks[a.id]=a})})}function i(){b.indexedCharacter={},g.query({bookID:d.bookID},function(a){a.forEach(function(a){b.indexedCharacter[a.id]=a})})}function j(){b.isLoading=!0,b.characterLinks=e.query({character:b.charId},function(){b.isLoading=!1})}function k(){h(),i(),j()}b.ctrlName="CharacterLinksCardCtrl",b.selectLink=function(a){b.selectedLink=a},b.resetSelection=function(){b.selectedLink=null},b.loadCharacterLinks=j,k(),b.$watch("charId",function(){b.loadCharacterLinks()})}]),needbookApp.directive("characterLinksCard",function(){return{restrict:"E",scope:{characters:"=",charId:"="},templateUrl:"shared/character/characterLinksCard.tmpl.html",controller:"CharacterLinksCardCtrl"}});var needbookApp=angular.module("needbookApp");needbookApp.controller("CharacterDetailsCtrl",["$scope","$state","$stateParams","$mdDialog","ToolbarService","BookCharacterModel","BookPlaceModel","BookModel",function(a,b,c,d,e,f,g,h){a.ctrlName="CharacterDetailsCtrl",a.traitsIcon={Names:"person",Gender:"gender"},a.loadCharacter=function(b){a.isLoading=!0,f.get({bookID:a.bookId,charID:b,simple:!1,"with":"traits,links,moves,actions"},function(b){e.setPageTitle(b.name()),a.events=b.mergeEvents(),a.selectedCharacter=b,a.isLoading=!1})},a.loadBook=function(b){a.book=h.get({id:b,populate:"map"}),a.places=g.query({bookID:b})},a.deleteCharacter=function(b){var c=d.confirm().title("Would you like to delete this character?").textContent("All of the data from other character related to this one will also be removed.").ariaLabel("Delete character").targetEvent(b).ok("Delete").cancel("Cancel");d.show(c).then(function(){f["delete"]({bookID:a.book.id,charID:a.charId})})},a.$watch("charId",function(b){a.loadCharacter(b)}),a.$watch("bookId",function(b){a.loadBook(b)})}]),needbookApp.directive("characterDetails",function(){return{restrict:"E",scope:{bookId:"=",charId:"="},templateUrl:"shared/character/characterDetails.tmpl.html",controller:"CharacterDetailsCtrl"}});var needbookApp=angular.module("needbookApp");needbookApp.controller("EmptyContentCtrl",["$scope",function(a){a.ctrlName="EmptyContentCtrl"}]),needbookApp.directive("emptyContent",function(){return{restrict:"E",scope:{icon:"@",text:"@"},templateUrl:"shared/core/empty-content/emptyContent.tmpl.html",controller:"EmptyContentCtrl"}});var needbookApp=angular.module("needbookApp");needbookApp.controller("LoadingCircleCtrl",["$scope",function(a){a.ctrlName="LoadingCircleCtrl"}]),needbookApp.directive("loadingCircle",function(){return{restrict:"E",scope:{loading:"="},templateUrl:"shared/core/loading-circle/loadingCircle.tmpl.html",controller:"LoadingCircleCtrl"}});var needbookApp=angular.module("needbookApp");needbookApp.controller("SearchInputCtrl",["$scope","$state","$stateParams",function(a,b,c){a.ctrlName="SearchInputCtrl",a.query=c.query||"",a.search=function(c){c.length>1&&b.go("app.search",{query:a.query})}}]),needbookApp.directive("searchInput",function(){return{restrict:"E",templateUrl:"shared/core/search/searchInput.tmpl.html",controller:"SearchInputCtrl"}});var needbookApp=angular.module("needbookApp");needbookApp.controller("SidenavCtrl",["$scope","$mdSidenav",function(a,b){a.close=function(){b("left").close()},a.menu=[{title:"library.title",state:"app.library.books",icon:"my_library_books"},{title:"discover.title",state:"app.discover",icon:"explore"},{title:"settings.title",state:"app.settings",icon:"settings"}]}]);var needbookApp=angular.module("needbookApp");needbookApp.controller("SimpleToolbarCtrl",["$scope","$state","$stateParams","$window","Locales",function(a,b,c,d,e){function f(){b.is("app.book.characters.new")||b.is("app.book.character")||b.is("app.book.character.edit")?a.prev=!0:a.prev=!1}function g(b){var c=b.target;if(c){var d=c.classList,e=d.contains("search-toolbar")||null!==c.parentElement&&c.parentElement.classList.contains("search-toolbar")||d.contains("search-input")||d.contains("search-input-container")||d.contains("search-input-form");return e?void 0:void a.toogleSearch()}}a.$window=d,a.lng=e.getLng(),a.isSearchVisible=!1,a.toogleSearch=function(){a.isSearchVisible=!a.isSearchVisible,a.isSearchVisible?a.$window.onclick=function(b){g(b,a.toggleSearch)}:(a.isSearchVisible=!1,a.$window.onclick=null,a.$$phase||a.$apply())},a.clearSearch=function(){""===a.query?a.toogleSearch():a.query=""},a.changeLng=function(a){e.setLng(a)},b.is("app.search")&&a.toogleSearch(),a.previous=function(){b.is("app.book.characters.new")||b.is("app.book.character")?b.go("app.book.details",{bookID:b.params.bookID},{reload:!0}):b.is("app.book.character.edit")&&b.go("app.book.character",{bookID:b.params.bookID,charID:b.params.charID},{reload:!0})},a.$on("$stateChangeSuccess",function(a,b){f()})}]);var needbookApp=angular.module("needbookApp");needbookApp.controller("LibraryToolbarCtrl",["_","$scope","$state","ToolbarService",function(a,b,c,d){function e(){var d=1;return a.find(b.tabs,function(a,b){return c.is(a.state)?(d=b,!0):void 0}),d}d.setPageTitle("library.title"),b.tabs=[{title:"book.title",state:"app.library.books"},{title:"serie.title",state:"app.library.series"},{title:"author.title",state:"app.library.authors"},{title:"book.favorite",state:"app.library.favorites"}],b.selectedIndex=e()}]);var needbookApp=angular.module("needbookApp");needbookApp.controller("BookToolbarCtrl",["_","$log","$rootScope","$scope","$state","$stateParams",function(a,b,c,d,e,f){function g(){var b=1;return a.find(d.tabs,function(a,c){var d=a.state.split("(")[0];return e.is(d)?(b=c,!0):void 0}),b}var h="app.book",i='{ bookID: "'+f.bookID+'"}',j=h+".details("+i+")",k=h+".characters("+i+")",l=h+".places("+i+")";d.tabs=[{title:"book.details",state:j},{title:"characters.title",state:k},{title:"places.title",state:l}],d.selectedIndex=g()}]);var needbookApp=angular.module("needbookApp");needbookApp.controller("MapCtrl",["$scope","$rootScope",function(a,b){var c=new ol.style.Style({stroke:new ol.style.Stroke({color:[255,236,179,1],width:3})}),d=new ol.style.Style({image:new ol.style.Circle({radius:6,fill:new ol.style.Fill({color:[255,236,179,1]}),stroke:new ol.style.Stroke({color:[255,236,179,1],width:1.5})}),zIndex:1/0}),e=new ol.style.Style({image:new ol.style.Circle({radius:6,fill:new ol.style.Fill({color:[232,44,12,1]}),stroke:new ol.style.Stroke({color:[232,44,12,1],width:1.5})}),zIndex:1/0});a.ctrlName="MapCtrl",a.initMap=function(){if(a.map&&a.map.extents&&a.map.url){a.omap&&a.omap.destroy();var b=new ol.proj.Projection({code:"map",units:"pixels",extent:a.map.extents});b.setWorldExtent(a.map.extents),a.omap=new ol.Map({target:"map",layers:[new ol.layer.Image({source:new ol.source.ImageStatic({attributions:[new ol.Attribution({html:"&copy; "+a.map.copyright})],url:a.map.url,projection:b,imageExtent:a.map.extents})})],view:new ol.View({projection:b,center:ol.extent.getCenter(a.map.extents),zoom:0,maxResolution:1,extent:a.map.extents})}),a.omap.on("click",function(b){a.$emit("mapClick",b)}),a.oplaces&&a.omap.addLayer(a.oplaces.layer),a.ocharacter&&a.omap.addLayer(a.omap.character),a.recenter()}},a.initPlaces=function(){a.oplaces||(a.oplaces={source:new ol.source.Vector({}),layer:new ol.layer.Vector({})},a.oplaces.layer.setSource(a.oplaces.source)),a.oplaces.source.clear();var b=!1;if(_.each(a.places,function(c){a.place&&a.place.id===c.id&&(c=a.place,b=!0);var f=new ol.Feature({geometry:new ol.geom.Point([c.coordinates.longitude,c.coordinates.latitude]),place:c});a.isEditable&&a.place&&c.id===a.place.id||!c.id?f.setStyle(e):f.setStyle(d),a.oplaces.source.addFeature(f)}),b===!1){var c=new ol.Feature({geometry:new ol.geom.Point([a.place.coordinates.longitude,a.place.coordinates.latitude]),place:a.place});a.isEditable?c.setStyle(e):c.setStyle(d),a.oplaces.source.addFeature(c)}a.omap&&a.omap.addLayer(a.oplaces.layer),a.character&&a.initCharacter(a.character)},a.initCharacter=function(b){if(a.places&&b){var d=_.indexBy(a.places,"id");a.ocharacter||(a.ocharacter={source:new ol.source.Vector({}),layer:new ol.layer.Vector({})},a.ocharacter.layer.setSource(a.ocharacter.source)),a.ocharacter.source.clear();var e=new ol.geom.MultiLineString([]);_.each(b.moves,function(a){var b=_.isObject(a.from)?a.from.id:a.from,c=_.isObject(a.to)?a.to.id:a.to;if(d[b]&&d[b]){var f=[d[b].coordinates.longitude,d[b].coordinates.latitude],g=[d[c].coordinates.longitude,d[c].coordinates.latitude],h=new ol.geom.LineString([f,g],"XY");e.appendLineString(h)}});var f=new ol.Feature({geometry:e,character:a.character});f.setStyle(c),a.ocharacter.source.addFeature(f),a.omap&&a.omap.addLayer(a.ocharacter.layer),a.recenter()}},a.recenter=function(){a.omap&&(a.center||a.character)&&(!a.center&&a.character&&(a.center=ol.extent.getCenter(a.ocharacter.source.getExtent())),a.omap.getView().setCenter(a.center))},a.$watch("map",a.initMap),a.$watch("places",a.initPlaces),a.$watch("place",a.initPlaces),a.$watch("character",a.initCharacter),a.$watch("center",a.recenter)}]),needbookApp.directive("map",function(){return{restrict:"E",scope:{map:"=",isEditable:"@",character:"=",place:"=",places:"=",center:"="},templateUrl:"shared/place/map.tmpl.html",controller:"MapCtrl"}}),angular.module("authControllers",[]);var authControllers=angular.module("authControllers");authControllers.controller("LoginCtrl",["$scope","AuthService",function(a,b){a.credentials={login:"",password:""},a.login=function(a){b.login(a)}}]);var authControllers=angular.module("authControllers");authControllers.controller("SignUpCtrl",["$scope","$mdToast","AUTH_EVENTS","AuthService",function(a,b,c,d){a.user={firstName:"",lastName:"",login:"",email:"",password:"",password_confirm:"",state:"validated"},a.signUp=function(a){d.register(a)},a.$on(c.registrationSuccess,function(){b.show(b.simple().position("bottom right").content("Registration Success"))}),a.$on(c.registrationFailed,function(){b.show(b.simple().position("bottom right").content("Registration Failure"))})}]),angular.module("authorControllers",[]);var authorControllers=angular.module("authorControllers");authorControllers.controller("AuthorListCtrl",["_","$scope","AuthorModel",function(a,b,c){var d=c;b.emptyMsg="author.not-found",b.isEmpty=!0,b.isLoading=!0,b.authors=d.query(function(c){b.isEmpty=a.isEmpty(c),b.isLoading=!1})}]);var authorControllers=angular.module("authorControllers");authorControllers.controller("AuthorDetailCtrl",["$scope","ToolbarService","AuthorData",function(a,b,c){b.setPageTitle(c.names[0]),a.author=c,a.books=c.books}]);var authorControllers=angular.module("authorControllers");authorControllers.controller("LibraryAuthorListCtrl",["_","$scope","AuthorModel",function(a,b){b.emptyMsg="author.not-found-library",b.isEmpty=!0,b.isLoading=!1,b.authors=[]}]),angular.module("bookControllers",[]);var bookControllers=angular.module("bookControllers");bookControllers.controller("BookDetailCtrl",["_","$scope","$state","$mdDialog","ToolbarService","LibraryModel","LibraryData","BookData","BookCharactersData","BookPlacesData",function(a,b,c,d,e,f,g,h,i,j){e.setPageTitle(h.title),b.book=h,b.bookId=h.id,b.editions=h.editions,b.authors=h.authors,b.edition=h.default_edition,b.map=h.map,b.added=a.find(g.books,function(a){return a.edition.id===b.edition.id}),b.characters=i,b.places=j,b.addMap=function(a){d.show({templateUrl:"/components/book/map/bookAddMap.tmpl.html",fullscreen:!0,targetEvent:a}).then(function(a){b.map=a})},b.goToPlace=function(a){c.go("app.book.place.edit",{placeID:a})},b.addToLibrary=function(a){f.addBook({id:a},function(){b.added=!0})},b.removeFromLibrary=function(a){f.removeBook({id:a},function(){b.added=!1})}}]);var bookControllers=angular.module("bookControllers");bookControllers.controller("LibraryBookListCtrl",["_","$scope","ToolbarService","LibraryData",function(a,b,c,d){c.setPageTitle("library.title"),b.emptyMsg="book.not-found-library",b.isEmpty=!0,b.isLoading=!0,b.books=[],a.forEach(d.books,function(c){if(c.edition.book){var d=c.edition.book;d.editions=[a.omit(c.edition,"book")],b.books.push(d)}}),b.isEmpty=a.isEmpty(d.books),b.isLoading=!1}]);var bookControllers=angular.module("bookControllers");bookControllers.controller("BookCharacterListCtrl",["_","$rootScope","$scope","$filter","ToolbarService","$state","$stateParams","BookCharacterModel","BookCharactersData","BookCharacterData",function(a,b,c,d,e,f,g,h,i,j){function k(){f.go("app.book.characters.new",{bookID:c.bookId})}function l(){f.go("app.book.character.edit",{bookID:c.bookId,charID:c.charId})}e.setPageTitle(j.name()),c.bookId=g.bookID,c.charId=g.charID,c.characters=i,c.character=j,c.traits=j.indexedTraits(),c.events=j.mergeEvents(),c.fab={isOpen:!1},c.fabActions=[{name:"Add character",icon:"person_add",action:k},{name:"Edit character",icon:"edit",action:l}],c.fabActionClick=function(a){c.fabActions[a].action()},c.goToCharacter=function(a){f.go("app.book.character",{bookID:c.bookId,charID:a})},c.orderByName=function(a){return a.name()}}]);var bookControllers=angular.module("bookControllers");bookControllers.controller("BookCharacterEditCtrl",["_","$rootScope","$scope","$mdToast","ToolbarService","$state","$mdDialog","BroadcastService","CHARACTER_EVENTS","CharacterModel","BookCharacterModel","CharacterTrait","CharacterTraitModel","CharacterTraitTypeModel","CharacterLink","CharacterLinkTypeModel","BookData","BookCharactersData","BookCharacterData","CharacterTraitTypesData","CharacterLinkTypesData",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u){function v(b){return a.map(b,function(a){return"Gender"===a.names.en_US&&(a.possible_values=["male","female","unknown"]),a})}function w(b){var c={};return a.forEach(b,function(a){c[a.names.en_US]=a}),c}function x(b){var d=-1;return a.forEach(c.character.traits,function(a,c){a.trait&&a.trait.names.en_US===b&&-1===d&&(d=c)}),d}function y(){c.bookId=q.id,c.charId=s.id,c.book=q,c.character=s.id?s:j["new"](),c.characters=r,c.indexedCharacters=a.indexBy(r,"id"),c.indexedCharacterTraits=c.character.indexedTraits(),c.character._editionMode=!0,c.traitTypes=v(t),c.indexedTraitTypes=w(c.traitTypes),c.charId&&c.character.traits.length||(c.character.traits.push(new l(null,{trait:c.indexedTraitTypes.Names,values:{en_US:[]}})),c.character.traits.push(new l(null,{trait:c.indexedTraitTypes.Gender,values:{en_US:[]}})),c.indexedCharacterTraits=c.character.indexedTraits()),-1===x("Picture")&&c.character.traits.push(new l(null,{trait:c.indexedTraitTypes.Picture,values:{en_US:[""]}})),c.characterNameIndex=x("Names"),c.characterGenderIndex=x("Gender"),c.characterPictureIndex=x("Picture"),c.linkTypes=u,c.indexedLinkTypes=a.indexBy(c.linkTypes,"id"),c.indexedCharacterLinks=c.character.indexedLinks(),c.newCharacterTraits=[],console.log(c.character)}function z(){n.query(function(b){c.traitTypes=v(b),c.indexedTraitTypes=a.indexBy(c.traitTypes,"names.en_US")})}function A(){p.query(function(b){c.linkTypes=b,c.indexedLinkTypes=a.indexBy(c.linkTypes,"id")})}function B(a){c.character.addEvent(a,c.book,c.book.default_edition),c.character.resetIndexing(),c.events=c.character.mergeEvents(),c.save()}s.id?e.setPageTitle("characters.edit"):e.setPageTitle("characters.new"),c.characterSearch=function(b){return b?c.characters.filter(function(c){var d=!1;return a.each(c.indexedTraits().names,function(a){-1!==angular.lowercase(a.values.en_US.join(",")).indexOf(angular.lowercase(b))&&(d=!0)}),d}):c.characters},c.characterTraitByName=function(b){return a.find(c.character.traits,function(a,c){return a.trait.names.en_US===b?a:void 0})},c.queryTraitSearch=function(b){return a.filter(c.traitTypes,function(a){var d=c.characterTraitByName(a.names.en_US);if(!d||a.multiple||d._edit){if(a.names.en_US&&b){var e=angular.lowercase(b),f=angular.lowercase(a.names.en_US);return 0===f.indexOf(e)}return a.names.en_US}return!1})},c.addCharacterTrait=function(a){c.character.id?(B(a),c.removeNewTrait(a),c.indexedCharacterTraits=c.character.indexedTraits()):(c.character.traits.push(a),c.removeNewTrait(a),c.indexedCharacterTraits=c.character.indexedTraits())},c.removeCharacterTrait=function(b){var d=a.findIndex(c.character.traits,b);b.id?m["delete"]({character:c.character.id,id:b.id},function(a){h.sendSuccess(i.deleteTraitSuccess,error)},function(a){h.sendFailure(i.deleteTraitFailed,a)}):(c.character.traits.splice(d,1),c.indexedCharacterTraits=c.character.indexedTraits())},c.newCharacterTrait=function(){c.newCharacterTraits.push(new l(null,null))},c.removeNewTrait=function(b){var d=a.findIndex(c.newCharacterTraits,b);c.newCharacterTraits.splice(d,1)},c.clearNewCharacterTraitValue=function(a){a.values.en_US=[]},c.selectLinkType=function(a){c.selectedLinkType=a[0].link},c.addCharacterLink=function(a){c.character.links.push(a),c.indexedCharacterLinks=c.character.indexedLinks(),c.save()},c.newTraitType=function(a){g.show({templateUrl:"/components/book/character/bookCharacterAddTraitType.tmpl.html",fullscreen:!0,targetEvent:a}).then(function(){z()})},c.newCharacterLink=function(a){g.show({templateUrl:"/components/book/character/bookCharacterAddLink.tmpl.html",fullscreen:!0,targetEvent:a}).then(function(a){c.addCharacterLink(a)})},c.newLinkType=function(a){g.show({templateUrl:"/components/book/character/bookCharacterAddLinkType.tmpl.html",fullscreen:!0,targetEvent:a}).then(function(a){A()})},c.newCharacterMove=function(a){g.show({templateUrl:"/components/book/character/bookCharacterAddMove.tmpl.html",fullscreen:!0,targetEvent:a}).then(function(a){c.character.moves.push(a)})},c.newCharacterAction=function(a){g.show({templateUrl:"/components/book/character/bookCharacterAddAction.tmpl.html",fullscreen:!0,targetEvent:a}).then(function(a){c.character.actions.push(a)})},c.save=function(){console.log(b);var b=angular.copy(c.character);b.locations.length&&(b.locations[0].edition=c.book.default_edition.id,b.locations[0].book=c.book.id),a.forEach(b.traits,function(a){a.begin_locations&&a.begin_locations.length&&!a.begin_locations[0].edition&&!a.begin_locations[0].book&&(a.begin_locations[0].edition=c.book.default_edition.id,a.begin_locations[0].book=c.book.id),a.end_locations&&a.end_locations.length&&!a.end_locations[0].edition&&!a.end_locations[0].book&&(a.end_locations[0].edition=c.book.default_edition.id,a.end_locations[0].book=c.book.id)}),b.traits[c.characterPictureIndex].values.en_US[0].length||b.traits.splice(c.characterPictureIndex,1);var d=j;console.log(b),d.save(b,function(a){b.id?(h.sendSuccess(i.updateSuccess,a),f.go("app.book.character.edit",{bookID:c.bookId,charID:a.id},{reload:!0})):k.save({bookID:c.bookId,charID:a.id},function(b){h.sendSuccess(i.createSuccess,b),f.go("app.book.character.edit",{bookID:c.bookId,charID:a.id},{reload:!0})},function(a){h.sendFailure(i.createFailed,a)})},function(a){h.sendSuccess(i.updateFailed,a)})},y(),b.$on(i.createSuccess,function(){d.show(d.simple().position("bottom right").content("Character has been created"))}),b.$on(i.createFailed,function(){d.show(d.simple().position("bottom right").content("Failed to create character"))}),b.$on(i.updateSuccess,function(){d.show(d.simple().position("bottom right").content("Character has been updated"))}),b.$on(i.updateFailed,function(){d.show(d.simple().position("bottom right").content("Failed to update character"))})}]);var bookControllers=angular.module("bookControllers");bookControllers.controller("oldBookCharacterEditCtrl",["_","$rootScope","$scope","ToolbarService","$state","$stateParams","$mdDialog","CharacterModel","BookCharacterModel","CharacterTraitModel","CharacterTraitTypeModel","CharacterLinkModel","CharacterLinkTypeModel","BookPlaceModel",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){c.progress=!1,f.charID?d.setPageTitle("Edit character"):d.setPageTitle("New character"),c.character={traits:[],links:[]},c.loadCharacters=function(b){i.query({bookID:b},function(b){f.charID&&(b=a.filter(b,function(a){return a.id===f.charID})),c.characters=b})},c.loadPlaces=function(a){n.query({bookID:a},function(a){c.places=a})},c.loadCharacter=function(a,b){c.progress=!0,i.get({bookID:a,charID:b,simple:!1,"with":"traits,links,moves"},function(a){c.character=a,c.progress=!1})},f.charID&&c.loadCharacter(f.bookID,f.charID),f.bookID&&(c.loadCharacters(f.bookID),c.loadPlaces(f.bookID)),b.title="New Character",c.save=function(){0!==c.character.traits.length&&h.save({id:f.charID},c.character,function(a){i.save({bookID:f.bookID},{character:a.id},function(){e.go("app.book.character.edit",{bookID:f.bookID,charID:a.id})})})},c.hasKeys=function(a){var b=0;for(var c in a)b++;return 0!==b}}]),bookControllers.controller("AddActionCtrl",["_","$scope","$stateParams","$mdDialog","BookModel","BookCharacterModel","CharacterAction","CharacterActionTypeModel",function(a,b,c,d,e,f,g,h){b.book=e.get({id:c.bookID},function(a){b.edition=a.default_edition}),b.characters=f.query({bookID:c.bookID}),b.action=new g,b.begin_locations=a.indexBy(b.action.begin_locations,"edition"),b.end_locations=a.indexBy(b.action.end_locations,"edition"),b.closeDialog=function(){b.action.to&&(b.action.begin_locations=a.map(b.begin_locations,function(a,b){return{edition:b,location:a.location,book:a.book}}),b.action.end_locations=a.map(b.end_locations,function(a,b){return{edition:b,location:a.location,book:a.book}}),d.hide(b.action))},b.cancelDialog=function(){d.cancel()},b.querySearch=function(a){return a&&""!==a?h.search({q:a},function(a){return a}).$promise:h.query(function(a){return a}).$promise},b.characterSearch=function(c){return c?b.characters.filter(function(b){var d=!1;return a.each(b.indexedTraits().names,function(a){-1!==angular.lowercase(a.values.en_US.join(",")).indexOf(angular.lowercase(c))&&(d=!0)}),d}):b.characters}}]),bookControllers.controller("AddMoveCtrl",["_","$scope","$stateParams","$mdDialog","BookPlaceModel",function(a,b,c,d,e){b.move={from:null,to:null,begin_locations:[],end_locations:[]},b.places=e.query({bookID:c.bookID}),b.closeDialog=function(){d.hide(b.move)},b.cancelDialog=function(){d.cancel()},b.querySearch=function(c){return c?b.places.filter(function(b){var d=!1;return a.each(b.traits.names.values.en_US,function(a){0===angular.lowercase(a).indexOf(angular.lowercase(c))&&(d=!0)}),d}):b.places}}]),bookControllers.controller("AddLinkCtrl",["_","$scope","$stateParams","$mdDialog","BroadcastService","CHARACTER_EVENTS","CharacterLinkTypeModel","BookCharacterModel","CharacterLink",function(a,b,c,d,e,f,g,h,i){b.characters=h.query({bookID:c.bookID}),b.character=h.get({bookID:c.bookID,charID:c.charID}),b.linkTypes=g.query(),b.searchLink="",b.searchChar="",b.link=new i(b.character),b.save=function(){(b.link.to||b.link.link)&&d.hide(b.link)},b.close=function(){d.cancel()},b.linkSearch=function(){return b.searchLink.length?b.linkTypes.filter(function(a){return 0===angularf.lowercase(a.names.en_US).indexOf(angular.lowercase(b.searchLink))}):b.linkTypes},b.characterSearch=function(){return b.searchChar.length?b.characters.filter(function(c){var d=!1;return a.each(c.indexedTraits().names,function(c){a.each(c.values.en_US,function(a){0===angular.lowercase(a).indexOf(angular.lowercase(b.searchChar))&&(d=!0)})}),d}):b.characters},b.addLinkValue=function(){b.newLinkValue&&""!==b.newLinkValue&&(b.link.values.en_US.push(b.newLinkValue),b.newLinkValue="")}}]),bookControllers.controller("AddLinkTypeCtrl",["$scope","$mdDialog","CharacterLinkTypeModel",function(a,b,c){a.newLinkTypeValue="",a.link_type={names:{en_US:""},reverse_link_type:null,reverse_itself:!1,sentences:{}},a.querySearch=function(a){return""===a?c.query(function(a){return a}).$promise:c.search({q:a},function(a){return a}).$promise},a.addLinkTypeValue=function(){a.newLinkTypeValue&&""!==a.newLinkTypeValue&&(a.link_type.possible_values.push(a.newLinkTypeValue),a.newLinkTypeValue="")},a.close=function(){b.cancel()},a.save=function(){a.link_type.reverse_itself===!0&&(a.link_type.reverse_link_type=null),c.post(a.link_type,function(a){b.hide(a)})}}]),bookControllers.controller("AddTraitTypeCtrl",["$scope","$mdDialog","CharacterTraitTypeModel",function(a,b,c){a.newTraitTypeValue="",a.traitType={names:{en_US:""},possible_values:[],primary:!1,multiple:!0},a.save=function(){a.possibleValues||(a.traitType.possible_values=[]),c.post(a.traitType,function(a){b.hide(a)})},a.close=function(){b.cancel()},a.addTraitTypeValue=function(){a.newTraitTypeValue&&""!==a.newTraitTypeValue&&(a.traitType.possible_values.push(a.newTraitTypeValue),a.newTraitTypeValue="")}}]);var bookControllers=angular.module("bookControllers");bookControllers.controller("BookPlaceListCtrl",["$rootScope","$scope","ToolbarService","$stateParams","BookPlaceModel",function(a,b,c,d,e){c.setPageTitle("places.title"),b.progress=!0,b.places=e.query({bookID:d.bookID},function(){b.progress=!1})}]);var bookControllers=angular.module("bookControllers");bookControllers.controller("BookPlaceDetailCtrl",["$scope","ToolbarService","BookPlaceData",function(a,b,c){b.setPageTitle(c.name()),a.place=c}]);var bookControllers=angular.module("bookControllers");bookControllers.controller("BookPlaceEditCtrl",["_","$rootScope","$scope","$state","$stateParams","$mdDialog","ToolbarService","BookData","BookPlaceData","BookPlacesData","PlaceTraitTypesData","PlaceModel","BookPlaceModel","PlaceTraitModel","PlaceTraitTypeModel","BookMapModel",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){function q(a,b,c,d){a.trait=d||{trait:null,values:{en_US:[]},begin_locations:[],end_locations:[]},a.save=function(){a.trait.values.length<=0||b.hide(a.trait)},a.close=function(){b.cancel()},a.querySearch=function(a){return o.query().$promise},a.addTraitValue=function(){a.newTraitValue&&""!==a.newTraitValue&&(a.trait.values.en_US.push(a.newTraitValue),a.newTraitValue="")},a.newTraitType=function(){b.show({templateUrl:"/components/book/place/bookPlaceAddTraitType.tmpl.html",controller:r}).then(function(b){a.trait.trait=b})["finally"](function(){c.addTraitDialog(a.trait)})}}function r(a,b,c){a.newTraitTypeValue="",a.trait_type={names:{en_US:""},possible_values:[],primary:!1,multiple:!0},a.save=function(){a.possibleValues||(a.trait_type.possible_values=[]),c.post(a.trait_type,function(a){b.hide(a)})},a.close=function(){b.cancel()},a.addTraitTypeValue=function(){a.newTraitTypeValue&&""!==a.newTraitTypeValue&&(a.trait_type.possible_values.push(a.newTraitTypeValue),a.newTraitTypeValue="")}}i.id?g.setPageTitle(i.name()):g.setPageTitle("places.new"),c.$on("mapClick",function(a,b){c.place.coordinates={longitude:b.coordinate[0],latitude:b.coordinate[1]},c.$apply(function(){c.place=angular.copy(c.place)})}),c.book=h,c.place=i.id?i:{traits:[],coordinates:{},map:h.map.id},c.places=j,c.placeTraitTypes=k,i.id||a.forEach(k,function(a){if(console.log(a),"Names"===a.names.en_US){var b={trait:a,values:{en_US:[]}};c.place.traits.push(b),console.log(c.place.traits)}}),c.addTraitDialog=function(a){f.show({templateUrl:"/components/book/place/bookPlaceAddTrait.tmpl.html",locals:{parentScope:c,trait:a},controller:q}).then(function(a){console.log(a),c.place.traits.push(a)})},c.save=function(){0!==c.place.traits.length&&(i.id?l.save({id:place.id},c.place,function(a){m.save({bookID:e.bookID},{place:a.id},function(){d.go("app.book.place.edit",{bookID:e.bookID,placeID:a.id},{reload:!0})})}):l.create(c.place,function(a){m.save({bookID:e.bookID},{place:a.id},function(){d.go("app.book.place.edit",{bookID:e.bookID,placeID:a.id},{reload:!0})})}))},c.hasKeys=function(a){var b=0;for(var c in a)b++;return 0!==b},q.$inject=["$scope","$mdDialog","parentScope","trait"],r.$inject=["$scope","$mdDialog","PlaceTraitTypeModel"]}]);var bookControllers=angular.module("bookControllers");bookControllers.controller("AddMapCtrl",["$log","$scope","$state","$stateParams","$mdDialog","BookModel","MapModel","BookMapModel",function(a,b,c,d,e,f,g,h){b.bookId=d.bookID,b.book=f.get({id:b.bookId}),b.map={names:{},url:""},b.save=function(){g.create(b.map,function(a){h.add({bookID:b.bookId,mapID:a.id},function(){e.cancel(),c.go("app.book.details",{bookID:b.bookId},{reload:!0})})})},b.close=function(){e.cancel()}}]);var needbookApp=angular.module("needbookApp");needbookApp.controller("SearchCtrl",["_","$scope","$timeout","ToolbarService","SearchData",function(a,b,c,d,e){function f(b,c){return a.forEach(c,function(c){return a.has(b,c)?void 0:!1}),!0}function g(b,c){var d=!0;return a.forEach(c,function(c){a.isEmpty(b[c])||(d=!1)}),d}d.setPageTitle("search.title"),b.results=e,b.emptyMsg="search.not-found",f(e,["author","book","serie","edition"])&&(b.isEmpty=g(e,["author","book","serie","edition"]))}]),angular.module("serieControllers",[]);var serieControllers=angular.module("serieControllers");serieControllers.controller("SerieListCtrl",["$scope",function(a){a.emptyMsg="serie.not-found-library",a.isEmpty=!0,a.isLoading=!1,a.series=[],a.isEmpty=_.isEmpty(a.series)}]);var serieControllers=angular.module("serieControllers");serieControllers.controller("SerieDetailCtrl",["$scope","$stateParams","SerieModel","ToolbarService",function(a,b,c,d,e){d.setPageTitle(e.name),a.serie=e}]);var needbookApp=angular.module("needbookApp");needbookApp.controller("HomeCtrl",[function(){}]);var needbookApp=angular.module("needbookApp");needbookApp.controller("HomeToolbarCtrl",["$scope","$state",function(a,b){a.selectedIndex=b.is("home.login")?0:1}]);var needbookApp=angular.module("needbookApp");needbookApp.controller("DiscoverCtrl",["_","$scope","ToolbarService","DiscoverBooksData",function(a,b,c,d){c.setPageTitle("discover.title"),b.books=d}]);var needbookApp=angular.module("needbookApp");
needbookApp.controller("SettingsCtrl",["$scope","$mdDialog","$i18next","AuthService","ToolbarService",function(a,b,c,d,e){e.setPageTitle("settings.title"),a.languages=[{name:c("language.french"),value:"fr",icon:"flag-icon-fr"},{name:c("language.english"),value:"en",icon:"flag-icon-us"}]}]);